name: Release Build & Upload

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build_tauri_desktop:
    name: Build Tauri Desktop Apps
    permissions:
      contents: write # Required to upload assets to the release
    strategy:
      fail-fast: false
      matrix:
        include:
          - os_desc: macos-intel
            platform: macos-13 # Intel-based macOS runner (Monterey)
          - os_desc: macos-arm
            platform: macos-14 # ARM-based macOS runner (Sonoma) - Apple Silicon
          - os_desc: ubuntu-latest
            platform: ubuntu-latest
          - os_desc: windows-latest
            platform: windows-latest
    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update version in tauri.conf.json and Cargo.toml
        run: |
          # Extract version from release tag (e.g., v1.0.44 -> 1.0.44)
          APP_VERSION=$(echo "${{ github.event.release.tag_name }}" | sed 's/^v//')
          echo "Using App Version: $APP_VERSION"
          
          # Update tauri.conf.json
          if command -v jq &> /dev/null
          then
            jq ".version = \"$APP_VERSION\"" src-tauri/tauri.conf.json > src-tauri/tauri.conf.json.tmp && mv src-tauri/tauri.conf.json.tmp src-tauri/tauri.conf.json
            echo "Updated version in src-tauri/tauri.conf.json to $APP_VERSION using jq"
          else
            sed -i.bak "s/\"version\": \".*\"/\"version\": \"$APP_VERSION\"/" src-tauri/tauri.conf.json
            echo "Updated version in src-tauri/tauri.conf.json to $APP_VERSION using sed"
          fi
          
          # Update Cargo.toml
          sed -i.bak "s/^version = \".*\"/version = \"$APP_VERSION\"/" src-tauri/Cargo.toml
          echo "Updated version in src-tauri/Cargo.toml to $APP_VERSION using sed"
        shell: bash

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Install Linux dependencies
        if: matrix.platform == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            librsvg2-bin \
            patchelf \
            libfuse2 \
            desktop-file-utils \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev \
            gstreamer1.0-plugins-good \
            gstreamer1.0-plugins-bad \
            gstreamer1.0-libav \
            libgdk-pixbuf2.0-bin \
            squashfs-tools \
            file \
            xdg-utils \
            appstream-util \
            ca-certificates \
            curl \
            wget \
            libssl-dev

      - name: Install frontend dependencies
        run: npm install

      - name: Build Tauri application (Windows/Linux using tauri-action)
        if: matrix.os_desc == 'ubuntu-latest' || matrix.os_desc == 'windows-latest'
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.event.release.tag_name }}
          releaseId: ${{ github.event.release.id }}
          projectPath: '.'

      - name: Build, Ad-hoc Sign, and Package macOS App
        if: matrix.os_desc == 'macos-intel' || matrix.os_desc == 'macos-arm'
        run: |
          echo "Starting macOS specific build process for ${{ matrix.os_desc }} on runner arch ${{ runner.arch }}..."
          
          # Build the .app bundle
          echo "Running npx tauri build..."
          npx tauri build
          
          APP_NAME_RAW=$(jq -r ".productName" src-tauri/tauri.conf.json)
          APP_PATH="src-tauri/target/release/bundle/macos/${APP_NAME_RAW}.app"
          
          if [ ! -d "$APP_PATH" ]; then
            echo "Error: ${APP_PATH} not found after tauri build!"
            ls -R src-tauri/target/release/bundle/macos/
            exit 1
          fi
          echo ".app bundle found at ${APP_PATH}"

          # Ad-hoc sign the .app bundle
          echo "Ad-hoc signing ${APP_PATH}..."
          codesign -s - --force --deep --options runtime "${APP_PATH}"
          echo "Ad-hoc signing complete."

          # Install create-dmg
          echo "Installing create-dmg..."
          if command -v brew &> /dev/null
          then
              brew install create-dmg
          else
              sudo npm install -g create-dmg
          fi
          echo "create-dmg installed."

          # Create the .dmg
          DMG_OUTPUT_DIR="src-tauri/target/release/bundle/dmg"
          mkdir -p "${DMG_OUTPUT_DIR}"
          DMG_NAME="${APP_NAME_RAW}-${{ github.event.release.tag_name }}-${{ runner.arch }}.dmg"
          DMG_PATH="${DMG_OUTPUT_DIR}/${DMG_NAME}"
          
          echo "Creating DMG: ${DMG_PATH} from ${APP_PATH}"
          create-dmg \
            --volname "${APP_NAME_RAW} ${{ github.event.release.tag_name }}" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --icon "${APP_NAME_RAW}.app" 200 190 \
            --hide-extension "${APP_NAME_RAW}.app" \
            --app-drop-link 600 185 \
            "${DMG_PATH}" \
            "${APP_PATH}"
          
          if [ ! -f "$DMG_PATH" ]; then
            echo "Error: DMG file ${DMG_PATH} not created!"
            exit 1
          fi
          echo "DMG created successfully at ${DMG_PATH}"

          # Upload the .dmg artifact
          echo "Uploading ${DMG_NAME}..."
          gh release upload ${{ github.event.release.tag_name }} "${DMG_PATH}" --clobber
          echo "DMG uploaded."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build_tauri_android_release:
    name: Build Tauri Android App (Release)
    permissions:
      contents: write
    runs-on: ubuntu-latest

    env:
      TAURI_ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      TAURI_ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
      TAURI_ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update version in tauri.conf.json and Cargo.toml
        run: |
          APP_VERSION=$(echo "${{ github.event.release.tag_name }}" | sed 's/^v//')
          echo "Using App Version: $APP_VERSION"
          
          if command -v jq &> /dev/null
          then
            jq ".version = \"$APP_VERSION\"" src-tauri/tauri.conf.json > src-tauri/tauri.conf.json.tmp && mv src-tauri/tauri.conf.json.tmp src-tauri/tauri.conf.json
            echo "Updated version in src-tauri/tauri.conf.json to $APP_VERSION using jq"
          else
            sed -i.bak "s/\"version\": \".*\"/\"version\": \"$APP_VERSION\"/" src-tauri/tauri.conf.json
            echo "Updated version in src-tauri/tauri.conf.json to $APP_VERSION using sed"
          fi
          
          sed -i.bak "s/^version = \".*\"/version = \"$APP_VERSION\"/" src-tauri/Cargo.toml
          echo "Updated version in src-tauri/Cargo.toml to $APP_VERSION using sed"
        shell: bash

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Install Android Rust targets
        run: |
          rustup target add aarch64-linux-android
          rustup target add armv7-linux-androideabi
          rustup target add i686-linux-android
          rustup target add x86_64-linux-android

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK and NDK
        uses: android-actions/setup-android@v3
        with:
          packages: 'ndk;25.2.9519653 platform-tools'

      - name: Set NDK_HOME globally
        run: |
          echo "NDK_HOME=${ANDROID_NDK_HOME}" >> $GITHUB_ENV
          echo "NDK_HOME has been set globally to: ${ANDROID_NDK_HOME}"

      - name: Install Android build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libglib2.0-dev libgtk-3-dev pkg-config libsoup-3.0-dev libjavascriptcoregtk-4.1-dev

      - name: Clean up potentially problematic custom Android resources
        run: |
          echo "Attempting to remove custom AndroidManifest.xml and themes.xml..."
          rm -f src-tauri/res/android/AndroidManifest.xml
          rm -f src-tauri/res/android/values/themes.xml
          echo "Cleanup of custom Android resources complete."
        shell: bash

      - name: Debug before Generate App Icons
        run: |
          echo "--- Debug: Before Generate App Icons ---"
          ls -la
          ls -la src-tauri/icons/ || echo "src-tauri/icons/ not found or empty."
          ls -R src-tauri/gen/android/app/src/main/res/mipmap* || echo "No mipmap directories found yet"
          echo "--- End Debug ---"
        shell: bash

      - name: Generate App Icons
        run: npx tauri icon icon.png

      - name: Debug after Generate App Icons
        run: |
          echo "--- Debug: After Generate App Icons ---"
          if [ -d "src-tauri/gen/android/app/src/main/res" ]; then
            find src-tauri/gen/android/app/src/main/res/ -type d -name "mipmap*" -print -exec ls -la {} \;
          else
            echo "src-tauri/gen/android/app/src/main/res directory not found."
          fi
          echo "--- End Debug ---"
        shell: bash

      - name: Initialize Tauri Android project and Check
        run: |
          echo "Current directory listing (before init):"
          ls -la
          echo "Deleting existing src-tauri/gen/android directory if it exists..."
          rm -rf src-tauri/gen/android
          
          echo "Verifying NDK environment variables..."
          echo "ANDROID_NDK_HOME is: $ANDROID_NDK_HOME"
          echo "NDK_HOME is: $NDK_HOME"
          
          echo "Running npm run tauri -- android init -vvv..."
          npm run tauri -- android init -vvv 2>&1
          INIT_EXIT_CODE=$?
          echo "tauri android init command finished with exit code: $INIT_EXIT_CODE"
          
          if [ $INIT_EXIT_CODE -ne 0 ]; then
            echo "Error: tauri android init command failed"
            exit $INIT_EXIT_CODE
          fi
        shell: bash

      - name: Generate App Icons (Post-Init)
        run: npx tauri icon icon.png

      - name: Override Android resources for immersive mode
        run: |
          echo "Overriding Android resources for immersive mode..."
          SOURCE_RES_DIR="src-tauri/mobile/android/app/src/main/res"
          DEST_RES_DIR="src-tauri/gen/android/app/src/main/res"

          if [ -d "$SOURCE_RES_DIR" ]; then
            echo "Source resource directory found at $SOURCE_RES_DIR"
            echo "Copying contents to $DEST_RES_DIR"
            rsync -av --copy-links "$SOURCE_RES_DIR/" "$DEST_RES_DIR/"
            echo "Resource override complete."
          else
            echo "::error:: Source resource directory for override not found at $SOURCE_RES_DIR"
            exit 1
          fi
        shell: bash

      - name: Override MainActivity for immersive mode
        run: |
          echo "Overriding MainActivity.kt for immersive mode..."
          SOURCE_ACTIVITY_PATH="src-tauri/mobile/android/app/src/main/java/com/libretv/app/MainActivity.kt"
          DEST_ACTIVITY_DIR="src-tauri/gen/android/app/src/main/java/com/libretv/app"
          
          if [ -f "$SOURCE_ACTIVITY_PATH" ]; then
            echo "Source MainActivity.kt found. Copying to $DEST_ACTIVITY_DIR"
            mkdir -p "$DEST_ACTIVITY_DIR"
            cp "$SOURCE_ACTIVITY_PATH" "$DEST_ACTIVITY_DIR/"
            echo "MainActivity.kt override complete."
          else
            echo "::error:: Source MainActivity.kt for override not found at $SOURCE_ACTIVITY_PATH"
            exit 1
          fi
        shell: bash

      - name: Decode Keystore for apksigner
        run: |
          echo "Decoding Keystore JKS for apksigner..."
          KEYSTORE_FILE_PATH="$RUNNER_TEMP/upload-keystore.jks"
          echo "${{ secrets.ANDROID_SIGNING_KEY_JKS_BASE64 }}" | base64 --decode > "$KEYSTORE_FILE_PATH"
          echo "Keystore JKS file decoded to $KEYSTORE_FILE_PATH"
          echo "SIGNING_KEYSTORE_PATH=$KEYSTORE_FILE_PATH" >> $GITHUB_ENV
        shell: bash

      - name: Verify Decoded Keystore
        run: |
          KEYSTORE_FILE_PATH="$RUNNER_TEMP/upload-keystore.jks"
          echo "Verifying keystore: $KEYSTORE_FILE_PATH with alias ${{ secrets.ANDROID_KEY_ALIAS }}"
          if [ ! -f "$KEYSTORE_FILE_PATH" ]; then
            echo "Error: Keystore file $KEYSTORE_FILE_PATH not found for verification!"
            exit 1
          fi
          keytool -list -v \
            -keystore "$KEYSTORE_FILE_PATH" \
            -storepass "${{ secrets.ANDROID_KEY_PASSWORD }}" \
            -alias "${{ secrets.ANDROID_KEY_ALIAS }}" \
            -keypass "${{ secrets.ANDROID_KEY_PASSWORD }}"
          echo "Keystore verification command executed successfully."
        shell: bash

      - name: Build Tauri Android application (Direct Command)
        run: npx tauri android build -v
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check AAB output and set path
        id: check_aab
        run: |
          AAB_DIR="src-tauri/gen/android/app/build/outputs/bundle"
          echo "Looking for AAB in $AAB_DIR..."
          
          AAB_CANDIDATE_SIGNED_UNIVERSAL="$AAB_DIR/universalRelease/app-universal-release.aab"
          AAB_CANDIDATE_SIGNED_RELEASE="$AAB_DIR/release/app-release.aab"
          AAB_CANDIDATE_UNSIGNED_RELEASE="$AAB_DIR/release/app-release-unsigned.aab"

          if [ -f "$AAB_CANDIDATE_UNSIGNED_RELEASE" ]; then
            AAB_PATH="$AAB_CANDIDATE_UNSIGNED_RELEASE"
            echo "Found unsigned release AAB: $AAB_PATH"
          elif [ -f "$AAB_CANDIDATE_SIGNED_RELEASE" ]; then
            AAB_PATH="$AAB_CANDIDATE_SIGNED_RELEASE"
            echo "Found signed release AAB: $AAB_PATH"
          elif [ -f "$AAB_CANDIDATE_SIGNED_UNIVERSAL" ]; then
            AAB_PATH="$AAB_CANDIDATE_SIGNED_UNIVERSAL"
            echo "Found universal release AAB: $AAB_PATH"
          else
            echo "Error: AAB file NOT found at expected locations."
            ls -R "$AAB_DIR" || echo "Bundle directory $AAB_DIR not found."
            exit 1
          fi
          
          echo "aab_file_path=$AAB_PATH" >> $GITHUB_OUTPUT
        shell: bash

      - name: Build Universal APK (unsigned) from AAB using bundletool
        id: build_unsigned_universal_apk
        run: |
          echo "Building unsigned Universal APK from AAB: ${{ steps.check_aab.outputs.aab_file_path }}"
          BTOOL_VERSION="1.16.0"
          wget https://github.com/google/bundletool/releases/download/${BTOOL_VERSION}/bundletool-all-${BTOOL_VERSION}.jar -O bundletool.jar
          
          java -jar bundletool.jar build-apks --bundle=${{ steps.check_aab.outputs.aab_file_path }} \
            --output=app_bundle_universal_unsigned.apks \
            --mode=universal
          echo "app_bundle_universal_unsigned.apks generated."
        shell: bash

      - name: Extract unsigned Universal APK
        id: extract_unsigned_apk_file
        run: |
          echo "Extracting unsigned Universal APK from app_bundle_universal_unsigned.apks..."
          mkdir -p extracted_universal_unsigned_apk
          unzip -oj app_bundle_universal_unsigned.apks universal.apk -d extracted_universal_unsigned_apk
          UNSIGNED_APK_PATH="extracted_universal_unsigned_apk/universal.apk"
          if [ -f "$UNSIGNED_APK_PATH" ]; then
            echo "unsigned_universal_apk_path=$UNSIGNED_APK_PATH" >> $GITHUB_OUTPUT
          else
            echo "::error::Unsigned Universal APK not found"
            exit 1
          fi
        shell: bash

      - name: Sign Universal APK (apksigner)
        id: sign_universal_apk
        run: |
          echo "Signing the Universal APK with apksigner..."
          APKSIGNER_PATH="$ANDROID_HOME/build-tools/$(ls $ANDROID_HOME/build-tools | sort -V -r | head -n 1)/apksigner"
          UNSIGNED_APK_PATH="${{ steps.extract_unsigned_apk_file.outputs.unsigned_universal_apk_path }}"
          SIGNED_APK_PATH="libretv-${{ github.event.release.tag_name }}-android-universal.apk"
          KEYSTORE_FILE="${{ env.SIGNING_KEYSTORE_PATH }}"

          "$APKSIGNER_PATH" sign \
            --verbose \
            --ks "$KEYSTORE_FILE" \
            --ks-key-alias "${{ secrets.ANDROID_KEY_ALIAS }}" \
            --ks-pass "pass:${{ secrets.ANDROID_KEY_PASSWORD }}" \
            --key-pass "pass:${{ secrets.ANDROID_KEY_PASSWORD }}" \
            --out "$SIGNED_APK_PATH" \
            "$UNSIGNED_APK_PATH"
          
          echo "signed_apk_path=$SIGNED_APK_PATH" >> $GITHUB_OUTPUT
        shell: bash

      - name: Upload Universal APK
        if: steps.sign_universal_apk.outputs.signed_apk_path != ''
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ${{ steps.sign_universal_apk.outputs.signed_apk_path }}
          asset_name: libretv-${{ github.event.release.tag_name }}-android-universal.apk
          asset_content_type: application/vnd.android.package-archive
